<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²ç™¼ç´ é£ŸéºµåŒ…åº— è¨‚å–®ç³»çµ±ï¼ˆé›²ç«¯ç‰ˆï¼‰</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { background: white; padding: 2rem; border-radius: 12px; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #D4915D; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw35OmDlvLHfjQwJcVPr5M7EMfZEC4OtIDSyt5yhkJu7w2gK9DT8EkEFHfJzVnyRZLd/exec';

        const WORSHIP_ITEMS = [
          { id: 'sansheng-bread', name: 'ä¸‰ç‰²éºµåŒ…', price: 190, note: 'å…§é¤¡ï¼šè‘¡è„ä¹¾', hasFillingOption: false },
          { id: 'wusheng-bread', name: 'äº”ç‰²éºµåŒ…', price: 260, note: 'å…§é¤¡ï¼šè‘¡è„ä¹¾', hasFillingOption: false },
          { id: 'sansheng-cake', name: 'ä¸‰ç‰²é¤…', price: 360, note: 'å…¬ç‰ˆï¼šçƒè±†æ²™+ç¶ è±†æ²™+é³³æ¢¨', hasFillingOption: true },
          { id: 'wusheng-cake', name: 'äº”ç‰²é¤…', price: 540, note: 'å…¬ç‰ˆï¼šçƒè±†æ²™+ç¶ è±†æ²™+é³³æ¢¨', hasFillingOption: true },
          { id: 'peach-bread', name: 'å£½æ¡ƒéºµåŒ…', price: 30, note: 'ç„¡åŒ…å…§é¤¡', hasFillingOption: false },
          { id: 'peach-cake-bean', name: 'å£½æ¡ƒé¤…ï¼ˆè±†æ²™é¤¡ï¼‰', price: 30, note: 'å¯é¸å…§é¤¡', hasFillingOption: true },
          { id: 'peach-cake-meat', name: 'å£½æ¡ƒé¤…ï¼ˆç´ é­¯è‚‰ï¼‰', price: 35, note: '', hasFillingOption: false },
          { id: 'sansheng-meat', name: 'å…¨ç´ é­¯è‚‰ä¸‰ç‰²é¤…', price: 400, note: 'å…¨éƒ¨åŒ…ç´ é­¯è‚‰', hasFillingOption: false },
          { id: 'wusheng-meat', name: 'å…¨ç´ é­¯è‚‰äº”ç‰²é¤…', price: 600, note: 'å…¨éƒ¨åŒ…ç´ é­¯è‚‰', hasFillingOption: false },
          { id: 'small-pudding', name: 'å°å¸ƒä¸', price: 70, note: '', hasFillingOption: false },
          { id: 'medium-pudding', name: 'ä¸­å¸ƒä¸', price: 150, note: '', hasFillingOption: false },
          { id: 'large-pudding', name: 'å¤§å¸ƒä¸', price: 250, note: '', hasFillingOption: false },
        ];

        // æ–°å¢ã€Œå…¬ç‰ˆå…§é¤¡ã€é¸é …
        const FILLING_OPTIONS = ['å…¬ç‰ˆå…§é¤¡', 'ç´…è±†', 'çƒè±†', 'ç¶ è±†', 'é³³æ¢¨', 'ç™½è±†'];
        const PICKUP_TIMES = ['ä¸‹åˆ4é»å‰', 'ä¸‹åˆ4é»å¾Œ', 'å…¶ä»–'];

        // --- (çœç•¥ä¸­é–“é‡è¤‡çš„ API å‡½æ•¸ï¼Œä¿æŒä¸è®Š) ---
        const generateOrderId = () => { const date = new Date(); const dateStr = date.toISOString().slice(0, 10).replace(/-/g, ''); const timeStr = date.getTime().toString().slice(-4); return `${dateStr}-${timeStr}`; };
        const fetchOrders = async () => { if (!GOOGLE_SCRIPT_URL) throw new Error('URLæœªè¨­å®š'); const response = await fetch(GOOGLE_SCRIPT_URL); const data = await response.json(); return data.orders; };
        const saveOrder = async (order) => { const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'add', order }) }); return await response.json(); };
        const updateOrderAPI = async (order) => { const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update', order }) }); return await response.json(); };
        const deleteOrderAPI = async (orderId) => { const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', orderId }) }); return await response.json(); };
        function LoadingOverlay({ message = 'è™•ç†ä¸­...' }) { return ( <div className="loading-overlay"><div className="loading-spinner"><div className="spinner"></div><div>{message}</div></div></div> ); }

        function BakeryOrderSystem() {
          const [currentView, setCurrentView] = useState('new-order');
          const [orders, setOrders] = useState([]);
          const [editingOrder, setEditingOrder] = useState(null);
          const [loading, setLoading] = useState(false);
          const [loadingMessage, setLoadingMessage] = useState('');
          const [error, setError] = useState('');

          const loadOrders = async () => { try { setLoading(true); setLoadingMessage('è¼‰å…¥ä¸­...'); const data = await fetchOrders(); setOrders(data); } catch (err) { alert(err.message); } finally { setLoading(false); } };
          useEffect(() => { loadOrders(); }, []);

          const handleOrderSubmit = async (order) => {
            try {
                setLoading(true);
                editingOrder ? await updateOrderAPI(order) : await saveOrder(order);
                await loadOrders();
                setEditingOrder(null);
                setCurrentView('order-list');
            } catch (err) { alert(err.message); } finally { setLoading(false); }
          };

          return (
            <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #FFF8E7 0%, #FFE8CC 100%)' }}>
              {loading && <LoadingOverlay message={loadingMessage} />}
              <nav style={{ background: '#D4915D', padding: '1rem 2rem', color: 'white' }}>
                <div style={{ maxWidth: '1400px', margin: '0 auto', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <h2>é€²ç™¼ç´ é£ŸéºµåŒ…åº— â˜ï¸</h2>
                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                    <button onClick={() => setCurrentView('new-order')} style={navBtnStyle}>â• æ–°å¢</button>
                    <button onClick={() => setCurrentView('order-list')} style={navBtnStyle}>ğŸ” åˆ—è¡¨</button>
                  </div>
                </div>
              </nav>
              <main style={{ maxWidth: '1400px', margin: '2rem auto', padding: '0 2rem' }}>
                {currentView === 'new-order' && <NewOrderForm onSubmit={handleOrderSubmit} editingOrder={editingOrder} onCancel={() => {setEditingOrder(null); setCurrentView('order-list');}} />}
                {currentView === 'order-list' && <OrderList orders={orders} onEdit={(o) => {setEditingOrder(o); setCurrentView('new-order');}} onDelete={async (id) => { if(confirm('åˆªé™¤ï¼Ÿ')){setLoading(true); await deleteOrderAPI(id); loadOrders(); setLoading(false);}}} />}
              </main>
            </div>
          );
        }

        const navBtnStyle = { padding: '0.5rem 1rem', background: 'rgba(255,255,255,0.2)', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' };

        // ==================== è¡¨å–®å…ƒä»¶ (ä¿®æ­£é‡é») ====================
        function NewOrderForm({ onSubmit, editingOrder, onCancel }) {
          const [worshipItems, setWorshipItems] = useState(editingOrder?.worshipItems ?? []);
          const [customerName, setCustomerName] = useState(editingOrder?.customerName ?? '');
          const [phone, setPhone] = useState(editingOrder?.phone ?? '');
          const [pickupDate, setPickupDate] = useState(editingOrder?.pickupDate ?? '');
          const [pickupTime, setPickupTime] = useState(editingOrder?.pickupTime ?? 'ä¸‹åˆ4é»å¾Œ');
          const [notes, setNotes] = useState(editingOrder?.notes ?? '');
          const [totalAmount, setTotalAmount] = useState(editingOrder?.totalAmount ?? 0);
          const [deposit, setDeposit] = useState(editingOrder?.deposit ?? 0);

          const updateWorshipItem = (index, field, value) => {
            const updated = [...worshipItems];
            let newValue = value;
            
            // é‚è¼¯å„ªåŒ–ï¼šå¦‚æœé¸æ“‡çš„æ˜¯ä¸‰ç‰²é¤…æˆ–äº”ç‰²é¤…ï¼Œè‡ªå‹•é è¨­å…§é¤¡ç‚ºã€Œå…¬ç‰ˆå…§é¤¡ã€
            if (field === 'itemId') {
                if (value === 'sansheng-cake' || value === 'wusheng-cake') {
                    updated[index] = { ...updated[index], [field]: value, filling: 'å…¬ç‰ˆå…§é¤¡' };
                } else {
                    updated[index] = { ...updated[index], [field]: value, filling: '' };
                }
            } else {
                updated[index] = { ...updated[index], [field]: value };
            }
            setWorshipItems(updated);
          };

          return (
            <div style={{ background: 'white', padding: '2rem', borderRadius: '12px' }}>
              <h2 style={{ marginBottom: '1.5rem', color: '#D4915D' }}>{editingOrder ? 'ç·¨è¼¯è¨‚å–®' : 'æ–°å¢è¨‚å–®'}</h2>
              <form onSubmit={(e) => { e.preventDefault(); onSubmit({ id: editingOrder?.id || generateOrderId(), worshipItems, customerName, phone, pickupDate, pickupTime, notes, totalAmount, deposit, createdAt: editingOrder?.createdAt || new Date().toISOString(), pickupStatus: editingOrder?.pickupStatus || 'æœªå–è²¨' }); }}>
                
                <div style={{ marginBottom: '2rem' }}>
                  <h3 style={{ borderLeft: '4px solid #D4915D', paddingLeft: '0.5rem', marginBottom: '1rem' }}>æ‹œæ‹œç”¨å“</h3>
                  {worshipItems.map((item, index) => (
                    <div key={index} style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem' }}>
                      <select value={item.itemId} onChange={(e) => updateWorshipItem(index, 'itemId', e.target.value)} style={inputStyle}>
                        <option value="">é¸æ“‡å•†å“</option>
                        {WORSHIP_ITEMS.map(wi => <option key={wi.id} value={wi.id}>{wi.name} (${wi.price})</option>)}
                      </select>
                      <input type="number" placeholder="æ•¸é‡" value={item.quantity} onChange={(e) => updateWorshipItem(index, 'quantity', e.target.value)} style={{...inputStyle, width: '80px'}} required />
                      
                      {/* å…§é¤¡é¸æ“‡æ¡† */}
                      {item.itemId && WORSHIP_ITEMS.find(w => w.id === item.itemId)?.hasFillingOption && (
                        <select value={item.filling} onChange={(e) => updateWorshipItem(index, 'filling', e.target.value)} style={inputStyle}>
                          <option value="">è«‹é¸æ“‡</option>
                          {FILLING_OPTIONS.map(f => <option key={f} value={f}>{f}</option>)}
                        </select>
                      )}
                      <button type="button" onClick={() => setWorshipItems(worshipItems.filter((_, i) => i !== index))} style={{background: '#ff6b6b', color:'white', border:'none', padding:'0.5rem', borderRadius:'4px'}}>ğŸ—‘ï¸</button>
                    </div>
                  ))}
                  <button type="button" onClick={() => setWorshipItems([...worshipItems, { itemId: '', quantity: 1, filling: '' }])} style={{padding:'0.5rem 1rem', background:'#D4915D', color:'white', border:'none', borderRadius:'4px'}}>+ æ–°å¢é …ç›®</button>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                  <label>å§“å <input style={inputStyle} type="text" value={customerName} onChange={e => setCustomerName(e.target.value)} required /></label>
                  <label>é›»è©± <input style={inputStyle} type="tel" value={phone} onChange={e => setPhone(e.target.value)} required /></label>
                  <label>å–è²¨æ—¥ <input style={inputStyle} type="date" value={pickupDate} onChange={e => setPickupDate(e.target.value)} required /></label>
                  <label>ç¸½é¡ <input style={inputStyle} type="number" value={totalAmount} onChange={e => setTotalAmount(e.target.value)} /></label>
                </div>

                <button type="submit" style={{width:'100%', padding:'1rem', background:'#4CAF50', color:'white', border:'none', borderRadius:'8px', fontSize:'1.2rem', fontWeight:'bold', cursor:'pointer'}}>ç¢ºèªé€å‡º</button>
                {editingOrder && <button type="button" onClick={onCancel} style={{width:'100%', marginTop:'0.5rem', padding:'0.5rem', background:'#eee', border:'none', borderRadius:'8px'}}>å–æ¶ˆ</button>}
              </form>
            </div>
          );
        }

        const inputStyle = { padding: '0.75rem', fontSize: '1rem', border: '1px solid #ccc', borderRadius: '4px', width: '100%' };

        // --- (çœç•¥ OrderList, ProductionList ç­‰å…¶ä»–åˆ—è¡¨é¡¯ç¤ºå…ƒä»¶ï¼Œå…¶é¤˜é‚è¼¯ä¸è®Š) ---
        function OrderList({ orders, onEdit, onDelete }) {
            return (
                <div style={{ background: 'white', padding: '1rem', borderRadius: '8px' }}>
                    <h3>è¨‚å–®ç®¡ç†</h3>
                    <table style={{ width: '100%', marginTop: '1rem', borderCollapse: 'collapse' }}>
                        <thead><tr style={{ background: '#f8f8f8' }}><th style={tdStyle}>æ—¥æœŸ</th><th style={tdStyle}>å®¢æˆ¶</th><th style={tdStyle}>å“é …</th><th style={tdStyle}>æ“ä½œ</th></tr></thead>
                        <tbody>
                            {orders.map(o => (
                                <tr key={o.id} style={{ borderBottom: '1px solid #eee' }}>
                                    <td style={tdStyle}>{o.pickupDate}</td>
                                    <td style={tdStyle}>{o.customerName}</td>
                                    <td style={tdStyle}>{o.worshipItems?.map(i => `${WORSHIP_ITEMS.find(w=>w.id===i.itemId)?.name || 'æœªçŸ¥'}(${i.filling || 'ç„¡'})x${i.quantity}`).join(', ')}</td>
                                    <td style={tdStyle}>
                                        <button onClick={() => onEdit(o)}>âœï¸</button>
                                        <button onClick={() => onDelete(o.id)}>ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }
        const tdStyle = { padding: '0.75rem', textAlign: 'left' };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BakeryOrderSystem />);
    </script>
</body>
</html>
