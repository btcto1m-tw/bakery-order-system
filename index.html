<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²ç™¼ç´ é£ŸéºµåŒ…åº— è¨‚å–®ç³»çµ±ï¼ˆé›²ç«¯ç‰ˆï¼‰</title>
    <!-- ==================== ç‰ˆæœ¬è³‡è¨Š ==================== -->
    <!-- ç‰ˆæœ¬ï¼šv2.2 - 2026-02-24 -->
    <!-- æ›´æ–°å…§å®¹ï¼šä¿®æ­£æœå°‹é‚è¼¯ã€å„ªåŒ–å…§é¤¡é¸é …ã€æ”¹é€²é‡‘é¡è¼¸å…¥ -->
    <!-- ================================================== -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #D4915D;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ============================================
        // ğŸ”§ é‡è¦è¨­å®šï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€
        // ============================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw35OmDlvLHfjQwJcVPr5M7EMfZEC4OtIDSyt5yhkJu7w2gK9DT8EkEFHfJzVnyRZLd/exec';
        // ç¯„ä¾‹ï¼š'https://script.google.com/macros/s/AKfycby.../exec'
        // ============================================

        // æ‹œæ‹œç”¨å“å•†å“æ¸…å–®
        const WORSHIP_ITEMS = [
          { id: 'sansheng-bread', name: 'ä¸‰ç‰²éºµåŒ…', price: 190, note: 'å…§é¤¡ï¼šè‘¡è„ä¹¾', hasFillingOption: false },
          { id: 'wusheng-bread', name: 'äº”ç‰²éºµåŒ…', price: 260, note: 'å…§é¤¡ï¼šè‘¡è„ä¹¾', hasFillingOption: false },
          { id: 'sansheng-cake', name: 'ä¸‰ç‰²é¤…', price: 360, note: 'å…¬ç‰ˆå…§é¤¡ï¼šçƒè±†æ²™ + ç¶ è±†æ²™ + é³³æ¢¨', hasFillingOption: true },
          { id: 'wusheng-cake', name: 'äº”ç‰²é¤…', price: 540, note: 'å…¬ç‰ˆå…§é¤¡ï¼šçƒè±†æ²™ + ç¶ è±†æ²™ + é³³æ¢¨', hasFillingOption: true },
          { id: 'peach-bread', name: 'å£½æ¡ƒéºµåŒ…', price: 30, note: 'ç„¡åŒ…å…§é¤¡', hasFillingOption: false },
          { id: 'peach-cake-bean', name: 'å£½æ¡ƒé¤…ï¼ˆè±†æ²™é¤¡ï¼‰', price: 30, note: 'å¯é¸å…§é¤¡', hasFillingOption: true },
          { id: 'peach-cake-meat', name: 'å£½æ¡ƒé¤…ï¼ˆç´ é­¯è‚‰ï¼‰', price: 35, note: '', hasFillingOption: false },
          { id: 'sansheng-meat', name: 'å…¨ç´ é­¯è‚‰ä¸‰ç‰²é¤…', price: 400, note: 'å…¨éƒ¨åŒ…ç´ é­¯è‚‰', hasFillingOption: false },
          { id: 'wusheng-meat', name: 'å…¨ç´ é­¯è‚‰äº”ç‰²é¤…', price: 600, note: 'å…¨éƒ¨åŒ…ç´ é­¯è‚‰', hasFillingOption: false },
          { id: 'small-pudding', name: 'å°å¸ƒä¸', price: 70, note: '', hasFillingOption: false },
          { id: 'medium-pudding', name: 'ä¸­å¸ƒä¸', price: 150, note: '', hasFillingOption: false },
          { id: 'large-pudding', name: 'å¤§å¸ƒä¸', price: 250, note: '', hasFillingOption: false },
        ];

        const FILLING_OPTIONS = ['ç´…è±†', 'çƒè±†', 'ç¶ è±†', 'é³³æ¢¨', 'ç™½è±†'];
        const PICKUP_TIMES = ['ä¸‹åˆ4é»å‰', 'ä¸‹åˆ4é»å¾Œ', 'å…¶ä»–'];

        // æ ¼å¼åŒ–å–è²¨æ™‚é–“é¡¯ç¤º
        const formatPickupTime = (pickupDate, pickupTime, customPickupTime) => {
          if (!pickupDate) return '';
          
          // ç§»é™¤å¯èƒ½çš„æ™‚é–“æˆ³è¨˜éƒ¨åˆ†ï¼Œåªä¿ç•™æ—¥æœŸ
          const dateOnly = pickupDate.split('T')[0];
          
          let timeStr = pickupTime;
          if (pickupTime === 'å…¶ä»–' && customPickupTime) {
            timeStr = customPickupTime;
          }
          
          return `${dateOnly} ${timeStr}`;
        };

        // æ™ºèƒ½è§£æå…¶ä»–å•†å“çš„åç¨±å’Œæ•¸é‡
        const parseOtherItem = (line) => {
          if (!line || !line.trim()) return null;
          
          const text = line.trim();
          
          // å˜—è©¦åŒ¹é…å„ç¨®æ ¼å¼
          // æ ¼å¼1: "å•†å“åç¨± xæ•¸å­—" æˆ– "å•†å“åç¨±xæ•¸å­—"
          let match = text.match(/^(.+?)\s*[xXÃ—]\s*(\d+)$/);
          if (match) {
            return { name: match[1].trim(), quantity: parseInt(match[2]) };
          }
          
          // æ ¼å¼2: "å•†å“åç¨± æ•¸å­—å€‹" æˆ– "å•†å“åç¨±æ•¸å­—å€‹"
          match = text.match(/^(.+?)\s*(\d+)\s*å€‹$/);
          if (match) {
            return { name: match[1].trim(), quantity: parseInt(match[2]) };
          }
          
          // æ ¼å¼3: "å•†å“åç¨± æ•¸å­—" (ç©ºæ ¼+ç´”æ•¸å­—)
          match = text.match(/^(.+?)\s+(\d+)$/);
          if (match) {
            return { name: match[1].trim(), quantity: parseInt(match[2]) };
          }
          
          // æ ¼å¼4: "å•†å“åç¨±æ•¸å­—" (ç„¡ç©ºæ ¼ï¼Œçµå°¾æ˜¯æ•¸å­—) - æ–°å¢
          // ç¢ºä¿å•†å“åç¨±è‡³å°‘2å€‹å­—ï¼Œé¿å…å°‡ "3" èª¤åˆ¤ç‚º "å•†å“åç¨±=ç©º, æ•¸é‡=3"
          match = text.match(/^(.{2,}?)(\d+)$/);
          if (match) {
            return { name: match[1].trim(), quantity: parseInt(match[2]) };
          }
          
          // æ ¼å¼5: æ²’æœ‰æ•¸é‡ï¼Œç•¶ä½œ1å€‹
          return { name: text, quantity: 1 };
        };

        // ç”Ÿæˆè¨‚å–®ç·¨è™Ÿ
        const generateOrderId = () => {
          const date = new Date();
          const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
          const timeStr = date.getTime().toString().slice(-4);
          return `${dateStr}-${timeStr}`;
        };

        // Google Sheets API å‡½æ•¸
        const fetchOrders = async () => {
          if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
            throw new Error('è«‹å…ˆè¨­å®š Google Apps Script URL');
          }
          
          const response = await fetch(GOOGLE_SCRIPT_URL);
          const data = await response.json();
          
          if (!data.success) {
            throw new Error(data.error || 'è®€å–è¨‚å–®å¤±æ•—');
          }
          
          return data.orders;
        };

        const saveOrder = async (order) => {
          if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
            throw new Error('è«‹å…ˆè¨­å®š Google Apps Script URL');
          }
          
          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'add',
              order: order
            })
          });
          
          const data = await response.json();
          
          if (!data.success) {
            throw new Error(data.error || 'å„²å­˜è¨‚å–®å¤±æ•—');
          }
          
          return data;
        };

        const updateOrderAPI = async (order) => {
          if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
            throw new Error('è«‹å…ˆè¨­å®š Google Apps Script URL');
          }
          
          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'update',
              order: order
            })
          });
          
          const data = await response.json();
          
          if (!data.success) {
            throw new Error(data.error || 'æ›´æ–°è¨‚å–®å¤±æ•—');
          }
          
          return data;
        };

        const deleteOrderAPI = async (orderId) => {
          if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
            throw new Error('è«‹å…ˆè¨­å®š Google Apps Script URL');
          }
          
          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'delete',
              orderId: orderId
            })
          });
          
          const data = await response.json();
          
          if (!data.success) {
            throw new Error(data.error || 'åˆªé™¤è¨‚å–®å¤±æ•—');
          }
          
          return data;
        };

        // è¼‰å…¥ä¸­ç•«é¢å…ƒä»¶
        function LoadingOverlay({ message = 'è™•ç†ä¸­...' }) {
          return (
            <div className="loading-overlay">
              <div className="loading-spinner">
                <div className="spinner"></div>
                <div>{message}</div>
              </div>
            </div>
          );
        }

        // ä¸»æ‡‰ç”¨ç¨‹å¼
        function BakeryOrderSystem() {
          const [currentView, setCurrentView] = useState('new-order');
          const [orders, setOrders] = useState([]);
          const [editingOrder, setEditingOrder] = useState(null);
          const [loading, setLoading] = useState(false);
          const [loadingMessage, setLoadingMessage] = useState('');
          const [error, setError] = useState('');

          // è¼‰å…¥è¨‚å–®
          const loadOrders = async () => {
            try {
              setLoading(true);
              setLoadingMessage('è¼‰å…¥è¨‚å–®è³‡æ–™...');
              const orders = await fetchOrders();
              setOrders(orders);
              setError('');
            } catch (err) {
              setError(err.message);
              alert('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š' + err.message);
            } finally {
              setLoading(false);
            }
          };

          // åˆå§‹è¼‰å…¥
          useEffect(() => {
            loadOrders();
          }, []);

          const addOrder = async (order) => {
            try {
              setLoading(true);
              setLoadingMessage('å„²å­˜è¨‚å–®...');
              await saveOrder(order);
              await loadOrders();
            } catch (err) {
              alert('æ–°å¢è¨‚å–®å¤±æ•—ï¼š' + err.message);
            } finally {
              setLoading(false);
            }
          };

          const updateOrder = async (order) => {
            try {
              setLoading(true);
              setLoadingMessage('æ›´æ–°è¨‚å–®...');
              await updateOrderAPI(order);
              await loadOrders();
            } catch (err) {
              alert('æ›´æ–°è¨‚å–®å¤±æ•—ï¼š' + err.message);
            } finally {
              setLoading(false);
            }
          };

          const deleteOrder = async (orderId) => {
            if (window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿ')) {
              try {
                setLoading(true);
                setLoadingMessage('åˆªé™¤è¨‚å–®...');
                await deleteOrderAPI(orderId);
                await loadOrders();
              } catch (err) {
                alert('åˆªé™¤è¨‚å–®å¤±æ•—ï¼š' + err.message);
              } finally {
                setLoading(false);
              }
            }
          };

          return (
            <div style={{
              minHeight: '100vh',
              background: 'linear-gradient(135deg, #FFF8E7 0%, #FFE8CC 100%)',
            }}>
              {loading && <LoadingOverlay message={loadingMessage} />}
              
              <nav style={{
                background: '#D4915D',
                padding: '1rem 2rem',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
              }}>
                <div style={{
                  maxWidth: '1400px',
                  margin: '0 auto',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '2rem',
                  flexWrap: 'wrap',
                }}>
                  <h1 style={{
                    fontSize: '1.8rem',
                    fontWeight: 'bold',
                    color: 'white',
                    letterSpacing: '0.05em',
                  }}>
                    é€²ç™¼ç´ é£ŸéºµåŒ…åº— è¨‚å–®ç³»çµ± â˜ï¸
                  </h1>
                  <div style={{ display: 'flex', gap: '0.5rem', marginLeft: 'auto', flexWrap: 'wrap' }}>
                    <NavButton
                      active={currentView === 'new-order'}
                      onClick={() => setCurrentView('new-order')}
                    >
                      â• æ–°å¢è¨‚å–®
                    </NavButton>
                    <NavButton
                      active={currentView === 'order-list'}
                      onClick={() => setCurrentView('order-list')}
                    >
                      ğŸ” è¨‚å–®ç®¡ç†
                    </NavButton>
                    <NavButton
                      active={currentView === 'production-list'}
                      onClick={() => setCurrentView('production-list')}
                    >
                      ğŸ“¦ è£½ä½œæ¸…å–®
                    </NavButton>
                    <NavButton
                      active={currentView === 'statistics'}
                      onClick={() => setCurrentView('statistics')}
                    >
                      ğŸ“Š å•†å“çµ±è¨ˆ
                    </NavButton>
                    <button
                      onClick={loadOrders}
                      style={{
                        padding: '0.75rem 1.5rem',
                        background: 'rgba(255,255,255,0.2)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '1rem',
                        cursor: 'pointer',
                      }}
                    >
                      ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                  </div>
                </div>
              </nav>

              {error && (
                <div style={{
                  maxWidth: '1400px',
                  margin: '1rem auto',
                  padding: '1rem 2rem',
                  background: '#FFEBEE',
                  color: '#C62828',
                  borderRadius: '8px',
                }}>
                  âš ï¸ {error}
                </div>
              )}

              <main style={{
                maxWidth: '1400px',
                margin: '2rem auto',
                padding: '0 2rem',
              }}>
                {currentView === 'new-order' && (
                  <NewOrderForm
                    onSubmit={async (order) => {
                      if (editingOrder) {
                        await updateOrder(order);
                        setEditingOrder(null);
                      } else {
                        await addOrder(order);
                      }
                      setCurrentView('order-list');
                    }}
                    editingOrder={editingOrder}
                    onCancel={() => {
                      setEditingOrder(null);
                      setCurrentView('order-list');
                    }}
                  />
                )}
                {currentView === 'order-list' && (
                  <OrderList
                    orders={orders}
                    onEdit={(order) => {
                      setEditingOrder(order);
                      setCurrentView('new-order');
                    }}
                    onDelete={deleteOrder}
                    onUpdateStatus={async (orderId, status) => {
                      const order = orders.find(o => o.id === orderId);
                      await updateOrder({ ...order, pickupStatus: status });
                    }}
                  />
                )}
                {currentView === 'production-list' && (
                  <ProductionList orders={orders} />
                )}
                {currentView === 'statistics' && (
                  <Statistics orders={orders} />
                )}
              </main>
            </div>
          );
        }

        function NavButton({ active, onClick, children }) {
          return (
            <button
              onClick={onClick}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem',
                padding: '0.75rem 1.5rem',
                background: active ? 'white' : 'rgba(255,255,255,0.2)',
                color: active ? '#D4915D' : 'white',
                border: 'none',
                borderRadius: '8px',
                fontSize: '1rem',
                fontWeight: active ? 'bold' : 'normal',
                cursor: 'pointer',
                transition: 'all 0.2s',
              }}
            >
              {children}
            </button>
          );
        }

        // ä»¥ä¸‹å…ƒä»¶èˆ‡åŸæœ¬ç›¸åŒï¼Œåƒ…åˆ—å‡ºé—œéµéƒ¨åˆ†
        // ï¼ˆç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œé€™è£¡ä½¿ç”¨åŸæœ¬çš„å…ƒä»¶ç¨‹å¼ç¢¼ï¼‰

        function NewOrderForm({ onSubmit, editingOrder, onCancel }) {
          const [hasEgg, setHasEgg] = useState(editingOrder?.hasEgg ?? false);
          const [worshipItems, setWorshipItems] = useState(editingOrder?.worshipItems ?? []);
          // å…¶ä»–å•†å“æ”¹å›ç°¡å–®å­—ä¸²
          const [otherItems, setOtherItems] = useState(() => {
            if (!editingOrder?.otherItems) return '';
            // å¦‚æœæ˜¯é™£åˆ—æ ¼å¼ï¼Œè½‰æ›æˆæ–‡å­—
            if (Array.isArray(editingOrder.otherItems)) {
              return editingOrder.otherItems.map(item => `${item.name} x${item.quantity}`).join('\n');
            }
            // å¦‚æœæ˜¯å­—ä¸²å°±ç›´æ¥ç”¨
            return editingOrder.otherItems;
          });
          const [totalAmount, setTotalAmount] = useState(editingOrder?.totalAmount ?? 0);
          const [deposit, setDeposit] = useState(editingOrder?.deposit ?? 0);
          const [pickupDate, setPickupDate] = useState(editingOrder?.pickupDate ?? '');
          const [pickupTime, setPickupTime] = useState(editingOrder?.pickupTime ?? 'ä¸‹åˆ4é»å¾Œ');
          const [customPickupTime, setCustomPickupTime] = useState(editingOrder?.customPickupTime ?? '');
          const [customerName, setCustomerName] = useState(editingOrder?.customerName ?? '');
          const [phone, setPhone] = useState(editingOrder?.phone ?? '');
          const [notes, setNotes] = useState(editingOrder?.notes ?? '');

          const addWorshipItem = () => {
            setWorshipItems([...worshipItems, { itemId: '', quantity: '', filling: '' }]);
          };

          const updateWorshipItem = (index, field, value) => {
            const updated = [...worshipItems];
            updated[index] = { ...updated[index], [field]: value };
            setWorshipItems(updated);
          };

          const removeWorshipItem = (index) => {
            setWorshipItems(worshipItems.filter((_, i) => i !== index));
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            
            if (!customerName || !phone || !pickupDate) {
              alert('è«‹å¡«å¯«å®¢æˆ¶å§“åã€é›»è©±å’Œå–è²¨æ—¥æœŸ');
              return;
            }

            const order = {
              id: editingOrder?.id || generateOrderId(),
              createdAt: editingOrder?.createdAt || new Date().toISOString(),
              hasEgg,
              worshipItems,
              otherItems,
              totalAmount: Number(totalAmount),
              deposit: Number(deposit),
              paymentStatus: deposit >= totalAmount ? 'å·²ä»˜æ¸…' : deposit > 0 ? 'å·²ä»˜è¨‚é‡‘' : 'æœªä»˜æ¬¾',
              pickupDate,
              pickupTime,
              customPickupTime: pickupTime === 'å…¶ä»–' ? customPickupTime : '',
              customerName,
              phone,
              notes,
              pickupStatus: editingOrder?.pickupStatus || 'æœªå–è²¨',
            };

            onSubmit(order);
          };

          return (
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '2rem',
              boxShadow: '0 4px 12px rgba(0,0,0,0.08)',
            }}>
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '2rem',
              }}>
                <h2 style={{ fontSize: '1.8rem', color: '#D4915D' }}>
                  {editingOrder ? 'ç·¨è¼¯è¨‚å–®' : 'æ–°å¢è¨‚å–®'}
                </h2>
                {editingOrder && (
                  <button
                    onClick={onCancel}
                    style={{
                      padding: '0.5rem 1rem',
                      background: '#f0f0f0',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                    }}
                  >
                    å–æ¶ˆç·¨è¼¯
                  </button>
                )}
              </div>

              <form onSubmit={handleSubmit}>
                <Section title="è›‹é¡é¸é …">
                  <div style={{ display: 'flex', gap: '1rem' }}>
                    <RadioButton
                      checked={!hasEgg}
                      onChange={() => setHasEgg(false)}
                      label="ç„¡è›‹"
                    />
                    <RadioButton
                      checked={hasEgg}
                      onChange={() => setHasEgg(true)}
                      label="æœ‰è›‹"
                    />
                  </div>
                </Section>

                <Section title="æ‹œæ‹œç”¨å“">
                  {worshipItems.map((item, index) => (
                    <div key={index} style={{
                      display: 'grid',
                      gridTemplateColumns: '2fr 1fr 1.5fr auto',
                      gap: '1rem',
                      marginBottom: '1rem',
                      alignItems: 'start',
                    }}>
                      <select
                        value={item.itemId}
                        onChange={(e) => updateWorshipItem(index, 'itemId', e.target.value)}
                        style={{
                          padding: '0.75rem',
                          fontSize: '1.1rem',
                          border: '2px solid #E0E0E0',
                          borderRadius: '8px',
                        }}
                      >
                        <option value="">é¸æ“‡å•†å“</option>
                        {WORSHIP_ITEMS.map(wi => (
                          <option key={wi.id} value={wi.id}>
                            {wi.name} - ${wi.price} {wi.note && `(${wi.note})`}
                          </option>
                        ))}
                      </select>

                      <input
                        type="number"
                        min="1"
                        value={item.quantity}
                        onChange={(e) => updateWorshipItem(index, 'quantity', e.target.value)}
                        placeholder="æ•¸é‡"
                        required
                        style={{
                          padding: '0.75rem',
                          fontSize: '1.1rem',
                          border: '2px solid #E0E0E0',
                          borderRadius: '8px',
                        }}
                      />

                      {item.itemId && WORSHIP_ITEMS.find(w => w.id === item.itemId)?.hasFillingOption && (
                        <select
                          value={item.filling}
                          onChange={(e) => updateWorshipItem(index, 'filling', e.target.value)}
                          style={{
                            padding: '0.75rem',
                            fontSize: '1.1rem',
                            border: '2px solid #E0E0E0',
                            borderRadius: '8px',
                          }}
                        >
                          <option value="">è«‹é¸æ“‡</option>
                          {FILLING_OPTIONS.map(f => (
                            <option key={f} value={f}>{f}</option>
                          ))}
                        </select>
                      )}

                      <button
                        type="button"
                        onClick={() => removeWorshipItem(index)}
                        style={{
                          padding: '0.75rem',
                          background: '#FF6B6B',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                        }}
                      >
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  ))}
                  <button
                    type="button"
                    onClick={addWorshipItem}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      padding: '0.75rem 1.5rem',
                      background: '#D4915D',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '1.1rem',
                      cursor: 'pointer',
                      marginTop: '1rem',
                    }}
                  >
                    â• æ–°å¢æ‹œæ‹œç”¨å“
                  </button>
                </Section>

                <Section title="å…¶ä»–å•†å“">
                  <textarea
                    value={otherItems}
                    onChange={(e) => setOtherItems(e.target.value)}
                    placeholder="æ¯è¡Œä¸€å€‹å•†å“ï¼Œæ”¯æ´å¤šç¨®æ ¼å¼ï¼š
ç´…è±†éºµåŒ… x5
èŠ‹é ­éºµåŒ… 5å€‹
æ³¢è˜¿éºµåŒ…10
è‚‰é¬†éºµåŒ…

ç³»çµ±æœƒè‡ªå‹•çµ±è¨ˆæ•¸é‡"
                    rows={6}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      fontSize: '1.1rem',
                      border: '2px solid #E0E0E0',
                      borderRadius: '8px',
                      fontFamily: 'inherit',
                      resize: 'vertical',
                    }}
                  />
                </Section>

                <Section title="å‚™è¨»">
                  <textarea
                    value={notes}
                    onChange={(e) => setNotes(e.target.value)}
                    placeholder="ç‰¹æ®Šéœ€æ±‚æˆ–æ³¨æ„äº‹é …"
                    rows={3}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      fontSize: '1.1rem',
                      border: '2px solid #E0E0E0',
                      borderRadius: '8px',
                      fontFamily: 'inherit',
                      resize: 'vertical',
                    }}
                  />
                </Section>

                <Section title="é‡‘é¡è³‡è¨Š">
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold', fontSize: '1.1rem' }}>
                        ç¸½é‡‘é¡
                      </label>
                      <input
                        type="text"
                        inputMode="numeric"
                        value={totalAmount === 0 ? '' : totalAmount}
                        onChange={(e) => {
                          const value = e.target.value.replace(/[^\d]/g, '');
                          setTotalAmount(value ? Number(value) : 0);
                        }}
                        placeholder="é‡‘é¡"
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          fontSize: '1.1rem',
                          border: '2px solid #E0E0E0',
                          borderRadius: '8px',
                        }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold', fontSize: '1.1rem' }}>
                        è¨‚é‡‘
                      </label>
                      <input
                        type="text"
                        inputMode="numeric"
                        value={deposit === 0 ? '' : deposit}
                        onChange={(e) => {
                          const value = e.target.value.replace(/[^\d]/g, '');
                          setDeposit(value ? Number(value) : 0);
                        }}
                        placeholder="è‹¥ç„¡å‰‡ç•™ç©º"
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          fontSize: '1.1rem',
                          border: '2px solid #E0E0E0',
                          borderRadius: '8px',
                        }}
                      />
                    </div>
                  </div>
                  <div style={{
                    marginTop: '1rem',
                    padding: '1rem',
                    background: '#FFF8E7',
                    borderRadius: '8px',
                    fontSize: '1.2rem',
                  }}>
                    <strong>å°¾æ¬¾ï¼š${totalAmount - deposit}</strong>
                    <span style={{ marginLeft: '2rem', color: '#666' }}>
                      ä»˜æ¬¾ç‹€æ…‹ï¼š{deposit >= totalAmount ? 'âœ“ å·²ä»˜æ¸…' : deposit > 0 ? 'â—‹ å·²ä»˜è¨‚é‡‘' : 'âœ— æœªä»˜æ¬¾'}
                    </span>
                  </div>
                </Section>

                <Section title="å–è²¨è³‡è¨Š">
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                    <Input
                      label="å–è²¨æ—¥æœŸ"
                      type="date"
                      value={pickupDate}
                      onChange={(e) => setPickupDate(e.target.value)}
                    />
                    <div>
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold', fontSize: '1.1rem' }}>
                        å–è²¨æ™‚æ®µ
                      </label>
                      <select
                        value={pickupTime}
                        onChange={(e) => setPickupTime(e.target.value)}
                        style={{
                          width: '100%',
                          padding: '0.75rem',
                          fontSize: '1.1rem',
                          border: '2px solid #E0E0E0',
                          borderRadius: '8px',
                        }}
                      >
                        {PICKUP_TIMES.map(time => (
                          <option key={time} value={time}>{time}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                  {pickupTime === 'å…¶ä»–' && (
                    <Input
                      label="æŒ‡å®šå–è²¨æ™‚é–“"
                      type="text"
                      value={customPickupTime}
                      onChange={(e) => setCustomPickupTime(e.target.value)}
                      placeholder="ä¾‹å¦‚ï¼šæ™šä¸Š8é»"
                    />
                  )}
                </Section>

                <Section title="å®¢æˆ¶è³‡è¨Š">
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                    <Input
                      label="å–è²¨äººå§“å"
                      type="text"
                      value={customerName}
                      onChange={(e) => setCustomerName(e.target.value)}
                      placeholder="ç‹å°æ˜"
                      required
                    />
                    <Input
                      label="é›»è©±"
                      type="tel"
                      value={phone}
                      onChange={(e) => setPhone(e.target.value)}
                      placeholder="0912345678"
                      required
                    />
                  </div>
                </Section>

                <div style={{ display: 'flex', gap: '1rem', marginTop: '2rem', flexWrap: 'wrap' }}>
                  <button
                    type="submit"
                    style={{
                      flex: 1,
                      minWidth: '200px',
                      padding: '1rem 2rem',
                      background: '#4CAF50',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '1.3rem',
                      fontWeight: 'bold',
                      cursor: 'pointer',
                    }}
                  >
                    {editingOrder ? 'æ›´æ–°è¨‚å–®' : 'å»ºç«‹è¨‚å–®'}
                  </button>
                  <button
                    type="button"
                    onClick={() => {
                      printReceipt({
                        id: generateOrderId(),
                        createdAt: new Date().toISOString(),
                        hasEgg,
                        worshipItems,
                        otherItems,
                        totalAmount: Number(totalAmount),
                        deposit: Number(deposit),
                        pickupDate,
                        pickupTime,
                        customPickupTime: pickupTime === 'å…¶ä»–' ? customPickupTime : '',
                        customerName,
                        phone,
                        notes,
                      });
                    }}
                    style={{
                      padding: '1rem 2rem',
                      background: '#2196F3',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '1.3rem',
                      fontWeight: 'bold',
                      cursor: 'pointer',
                    }}
                  >
                    ğŸ–¨ï¸ é è¦½æ”¶æ“š
                  </button>
                </div>
              </form>
            </div>
          );
        }

        // OrderList, ProductionList, Statistics ç­‰å…ƒä»¶èˆ‡åŸæœ¬ç›¸åŒ
        // ç‚ºäº†æª”æ¡ˆå¤§å°ï¼Œé€™è£¡çœç•¥ï¼Œå¯¦éš›ä½¿ç”¨æ™‚è«‹è¤‡è£½å®Œæ•´ç¨‹å¼ç¢¼

        function OrderList({ orders, onEdit, onDelete, onUpdateStatus }) {
          const [searchTerm, setSearchTerm] = useState('');
          const [filterDate, setFilterDate] = useState('');
          const [filterStatus, setFilterStatus] = useState('all');

          const filteredOrders = orders.filter(order => {
            const matchSearch = !searchTerm || 
              order.customerName.includes(searchTerm) ||
              order.phone.includes(searchTerm) ||
              order.id.includes(searchTerm);
            
            const matchDate = !filterDate || order.pickupDate === filterDate;
            const matchStatus = filterStatus === 'all' || order.pickupStatus === filterStatus;

            return matchSearch && matchDate && matchStatus;
          });

          const sortedOrders = [...filteredOrders].sort((a, b) => 
            new Date(b.createdAt) - new Date(a.createdAt)
          );

          return (
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '2rem',
              boxShadow: '0 4px 12px rgba(0,0,0,0.08)',
            }}>
              <h2 style={{ fontSize: '1.8rem', color: '#D4915D', marginBottom: '2rem' }}>
                è¨‚å–®ç®¡ç†
              </h2>

              <div style={{
                display: 'grid',
                gridTemplateColumns: '2fr 1fr 1fr',
                gap: '1rem',
                marginBottom: '2rem',
              }}>
                <input
                  type="text"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  placeholder="æœå°‹å®¢æˆ¶å§“åã€é›»è©±æˆ–è¨‚å–®ç·¨è™Ÿ..."
                  style={{
                    padding: '0.75rem',
                    fontSize: '1.1rem',
                    border: '2px solid #E0E0E0',
                    borderRadius: '8px',
                  }}
                />
                <input
                  type="date"
                  value={filterDate}
                  onChange={(e) => setFilterDate(e.target.value)}
                  style={{
                    padding: '0.75rem',
                    fontSize: '1.1rem',
                    border: '2px solid #E0E0E0',
                    borderRadius: '8px',
                  }}
                />
                <select
                  value={filterStatus}
                  onChange={(e) => setFilterStatus(e.target.value)}
                  style={{
                    padding: '0.75rem',
                    fontSize: '1.1rem',
                    border: '2px solid #E0E0E0',
                    borderRadius: '8px',
                  }}
                >
                  <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                  <option value="æœªå–è²¨">æœªå–è²¨</option>
                  <option value="å·²å–è²¨">å·²å–è²¨</option>
                  <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
                </select>
              </div>

              <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                {sortedOrders.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '3rem', color: '#999', fontSize: '1.2rem' }}>
                    æ²’æœ‰æ‰¾åˆ°è¨‚å–®
                  </div>
                ) : (
                  sortedOrders.map(order => (
                    <OrderCard
                      key={order.id}
                      order={order}
                      onEdit={() => onEdit(order)}
                      onDelete={() => onDelete(order.id)}
                      onPrint={() => printReceipt(order)}
                      onUpdateStatus={(status) => onUpdateStatus(order.id, status)}
                    />
                  ))
                )}
              </div>
            </div>
          );
        }

        function OrderCard({ order, onEdit, onDelete, onPrint, onUpdateStatus }) {
          const isOverdue = order.pickupStatus === 'æœªå–è²¨' && new Date(order.pickupDate) < new Date();

          return (
            <div style={{
              border: `2px solid ${isOverdue ? '#FF6B6B' : '#E0E0E0'}`,
              borderRadius: '8px',
              padding: '1.5rem',
              background: isOverdue ? '#FFF0F0' : 'white',
            }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', flexWrap: 'wrap', gap: '1rem' }}>
                <div style={{ flex: 1, minWidth: '300px' }}>
                  <div style={{ display: 'flex', gap: '1rem', marginBottom: '1rem', flexWrap: 'wrap' }}>
                    <span style={{
                      padding: '0.25rem 0.75rem',
                      background: order.hasEgg ? '#FFE5B4' : '#E8F5E9',
                      borderRadius: '4px',
                      fontSize: '0.9rem',
                      fontWeight: 'bold',
                    }}>
                      {order.hasEgg ? 'æœ‰è›‹' : 'ç„¡è›‹'}
                    </span>
                    <span style={{
                      padding: '0.25rem 0.75rem',
                      background: order.pickupStatus === 'å·²å–è²¨' ? '#C8E6C9' : 
                                  order.pickupStatus === 'å·²å–æ¶ˆ' ? '#FFCDD2' : '#FFF9C4',
                      borderRadius: '4px',
                      fontSize: '0.9rem',
                      fontWeight: 'bold',
                    }}>
                      {order.pickupStatus}
                    </span>
                    <span style={{
                      padding: '0.25rem 0.75rem',
                      background: order.paymentStatus === 'å·²ä»˜æ¸…' ? '#C8E6C9' :
                                  order.paymentStatus === 'å·²ä»˜è¨‚é‡‘' ? '#FFF9C4' : '#FFCDD2',
                      borderRadius: '4px',
                      fontSize: '0.9rem',
                      fontWeight: 'bold',
                    }}>
                      {order.paymentStatus}
                    </span>
                  </div>

                  <div style={{ fontSize: '1.1rem', lineHeight: '1.8' }}>
                    <div><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>{order.id}</div>
                    <div><strong>å–è²¨äººï¼š</strong>{order.customerName} | {order.phone}</div>
                    <div>
                      <strong>å–è²¨æ™‚é–“ï¼š</strong>
                      {formatPickupTime(order.pickupDate, order.pickupTime, order.customPickupTime)}
                    </div>
                    <div><strong>ç¸½é‡‘é¡ï¼š</strong>${order.totalAmount} | <strong>è¨‚é‡‘ï¼š</strong>${order.deposit} | <strong>å°¾æ¬¾ï¼š</strong>${order.totalAmount - order.deposit}</div>
                    
                    {order.worshipItems && order.worshipItems.length > 0 && (
                      <div style={{ marginTop: '0.5rem' }}>
                        <strong>æ‹œæ‹œç”¨å“ï¼š</strong>
                        {order.worshipItems.map((item, idx) => {
                          const itemInfo = WORSHIP_ITEMS.find(w => w.id === item.itemId);
                          return itemInfo ? (
                            <span key={idx}>
                              {itemInfo.name} x{item.quantity}
                              {item.filling && ` (${item.filling})`}
                              {idx < order.worshipItems.length - 1 ? 'ã€' : ''}
                            </span>
                          ) : null;
                        })}
                      </div>
                    )}
                    
                    {order.otherItems && (
                      <div style={{ marginTop: '0.5rem' }}>
                        <strong>å…¶ä»–å•†å“ï¼š</strong>
                        <pre style={{ 
                          display: 'inline',
                          whiteSpace: 'pre-wrap',
                          fontFamily: 'inherit',
                          margin: 0,
                        }}>
                          {order.otherItems}
                        </pre>
                      </div>
                    )}
                    
                    {order.notes && (
                      <div style={{ marginTop: '0.5rem' }}>
                        <strong>å‚™è¨»ï¼š</strong>{order.notes}
                      </div>
                    )}
                  </div>
                </div>

                <div style={{ display: 'flex', gap: '0.5rem', flexDirection: 'column' }}>
                  {order.pickupStatus === 'æœªå–è²¨' && (
                    <button
                      onClick={() => onUpdateStatus('å·²å–è²¨')}
                      style={{
                        padding: '0.5rem 1rem',
                        background: '#4CAF50',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontSize: '1rem',
                      }}
                    >
                      æ¨™è¨˜å·²å–è²¨
                    </button>
                  )}
                  <button
                    onClick={onPrint}
                    style={{
                      padding: '0.5rem 1rem',
                      background: '#2196F3',
                      color: 'white',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontSize: '1rem',
                    }}
                  >
                    ğŸ–¨ï¸ åˆ—å°
                  </button>
                  <button
                    onClick={onEdit}
                    style={{
                      padding: '0.5rem 1rem',
                      background: '#FF9800',
                      color: 'white',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontSize: '1rem',
                    }}
                  >
                    ç·¨è¼¯
                  </button>
                  <button
                    onClick={onDelete}
                    style={{
                      padding: '0.5rem 1rem',
                      background: '#F44336',
                      color: 'white',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontSize: '1rem',
                    }}
                  >
                    åˆªé™¤
                  </button>
                </div>
              </div>
            </div>
          );
        }

        function ProductionList({ orders }) {
          // å–å¾—æœ¬åœ°æ™‚å€çš„ä»Šå¤©æ—¥æœŸ
          const getLocalDate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          };
          
          const [selectedDate, setSelectedDate] = useState(getLocalDate());

          // è¨ˆç®—éš”å¤©æ—¥æœŸï¼ˆé¿å…æ™‚å€å•é¡Œï¼‰
          const getNextDay = (dateStr) => {
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
            date.setUTCDate(date.getUTCDate() + 1);
            const nextYear = date.getUTCFullYear();
            const nextMonth = String(date.getUTCMonth() + 1).padStart(2, '0');
            const nextDay = String(date.getUTCDate()).padStart(2, '0');
            return `${nextYear}-${nextMonth}-${nextDay}`;
          };

          const nextDayStr = getNextDay(selectedDate);

          // ç¯©é¸è¨‚å–®æ™‚åªæ¯”è¼ƒæ—¥æœŸéƒ¨åˆ†
          const getDateOnly = (dateStr) => {
            if (!dateStr) return '';
            return dateStr.split('T')[0];
          };

          const todayAfter4 = orders.filter(o => {
            const orderDate = getDateOnly(o.pickupDate);
            return orderDate === selectedDate && 
                   o.pickupTime === 'ä¸‹åˆ4é»å¾Œ' &&
                   o.pickupStatus === 'æœªå–è²¨';
          });

          const tomorrowBefore4 = orders.filter(o => {
            const orderDate = getDateOnly(o.pickupDate);
            return orderDate === nextDayStr && 
                   o.pickupTime === 'ä¸‹åˆ4é»å‰' &&
                   o.pickupStatus === 'æœªå–è²¨';
          });

          const allProductionOrders = [...todayAfter4, ...tomorrowBefore4];
          
          console.log('Selected date:', selectedDate);
          console.log('Next day:', nextDayStr);
          console.log('Today after 4:', todayAfter4);
          console.log('Tomorrow before 4:', tomorrowBefore4);

          const itemStats = {};
          
          allProductionOrders.forEach(order => {
            // çµ±è¨ˆæ‹œæ‹œç”¨å“
            if (order.worshipItems && Array.isArray(order.worshipItems)) {
              order.worshipItems.forEach(item => {
                const itemInfo = WORSHIP_ITEMS.find(w => w.id === item.itemId);
                if (itemInfo) {
                  const key = item.filling ? 
                    `${itemInfo.name} (${item.filling})` : 
                    itemInfo.name;
                  itemStats[key] = (itemStats[key] || 0) + Number(item.quantity);
                }
              });
            }
            
            // æ™ºèƒ½è§£æä¸¦çµ±è¨ˆå…¶ä»–å•†å“
            if (order.otherItems && order.otherItems.trim()) {
              const lines = order.otherItems.split('\n');
              lines.forEach(line => {
                if (line.trim()) {
                  // æ™ºèƒ½è§£ææ ¼å¼
                  const parsed = parseOtherItem(line.trim());
                  if (parsed) {
                    itemStats[parsed.name] = (itemStats[parsed.name] || 0) + parsed.quantity;
                  }
                }
              });
            }
          });
          
          console.log('Item stats:', itemStats);

          const handlePrint = () => {
            const content = generateProductionListContent(todayAfter4, tomorrowBefore4, itemStats, selectedDate);
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
              <html>
                <head>
                  <title>è£½ä½œæ¸…å–®</title>
                  <style>
                    body { font-family: monospace; white-space: pre; font-size: 14px; }
                    @media print {
                      body { margin: 0; padding: 20px; }
                    }
                  </style>
                </head>
                <body>${content}</body>
              </html>
            `);
            printWindow.document.close();
            printWindow.print();
          };

          const content = generateProductionListContent(todayAfter4, tomorrowBefore4, itemStats, selectedDate);

          return (
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '2rem',
              boxShadow: '0 4px 12px rgba(0,0,0,0.08)',
            }}>
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '2rem',
                flexWrap: 'wrap',
                gap: '1rem',
              }}>
                <h2 style={{ fontSize: '1.8rem', color: '#D4915D', margin: 0 }}>
                  è£½ä½œæ¸…å–®
                </h2>
                <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap' }}>
                  <div>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold', fontSize: '1.1rem' }}>
                      é¸æ“‡æ—¥æœŸ
                    </label>
                    <input
                      type="date"
                      value={selectedDate}
                      onChange={(e) => setSelectedDate(e.target.value)}
                      style={{
                        padding: '0.75rem',
                        fontSize: '1.1rem',
                        border: '2px solid #E0E0E0',
                        borderRadius: '8px',
                      }}
                    />
                  </div>
                  <button
                    onClick={handlePrint}
                    style={{
                      padding: '0.75rem 1.5rem',
                      background: '#2196F3',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '1.1rem',
                      cursor: 'pointer',
                      marginTop: '1.5rem',
                    }}
                  >
                    ğŸ–¨ï¸ åˆ—å°è£½ä½œæ¸…å–®
                  </button>
                </div>
              </div>

              <div style={{
                background: '#FFF8E7',
                padding: '1.5rem',
                borderRadius: '8px',
                fontFamily: 'monospace',
                fontSize: '1.1rem',
                lineHeight: '1.8',
                whiteSpace: 'pre-wrap',
              }}>
                {content}
              </div>
            </div>
          );
        }

        function generateProductionListContent(todayAfter4, tomorrowBefore4, itemStats, selectedDate) {
          // ä½¿ç”¨æœ¬åœ°æ™‚å€æ ¼å¼åŒ–æ—¥æœŸï¼Œé¿å…æ™‚å€å•é¡Œ
          const formatDateLocal = (dateStr) => {
            const [year, month, day] = dateStr.split('-').map(Number);
            // ä½¿ç”¨ UTC é¿å…æ™‚å€å•é¡Œ
            const date = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            const weekday = weekdays[date.getUTCDay()];
            return `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')} ${weekday}`;
          };
          
          const selectedDateFormatted = formatDateLocal(selectedDate);
          
          // è¨ˆç®—éš”å¤© - ä½¿ç”¨ UTC é¿å…æ™‚å€å•é¡Œ
          const [year, month, day] = selectedDate.split('-').map(Number);
          const nextDate = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
          nextDate.setUTCDate(nextDate.getUTCDate() + 1);
          const nextYear = nextDate.getUTCFullYear();
          const nextMonth = String(nextDate.getUTCMonth() + 1).padStart(2, '0');
          const nextDay = String(nextDate.getUTCDate()).padStart(2, '0');
          const nextDateStr = `${nextYear}-${nextMonth}-${nextDay}`;
          const nextDateFormatted = formatDateLocal(nextDateStr);

          let content = `================================\n`;
          content += `      è£½ä½œæ¸…å–®\n`;
          content += `     ${selectedDateFormatted}\n`;
          content += `================================\n\n`;

          if (todayAfter4.length > 0) {
            content += `${selectedDateFormatted.split(' ')[0]} ä¸‹åˆ4é»å¾Œå–è²¨ï¼š\n`;
            content += `--------------------------------\n`;
            todayAfter4.forEach(order => {
              content += `${order.customerName} - `;
              
              // é¡¯ç¤ºæ‹œæ‹œç”¨å“
              if (order.worshipItems && order.worshipItems.length > 0) {
                order.worshipItems.forEach(item => {
                  const itemInfo = WORSHIP_ITEMS.find(w => w.id === item.itemId);
                  if (itemInfo) {
                    content += `${itemInfo.name} x${item.quantity}`;
                    if (item.filling) content += ` (${item.filling})`;
                    content += ' ';
                  }
                });
              }
              
              // é¡¯ç¤ºå…¶ä»–å•†å“
              if (order.otherItems && order.otherItems.trim()) {
                content += order.otherItems.replace(/\n/g, ' ');
              }
              
              content += '\n';
            });
            content += '\n';
          } else {
            content += `${selectedDateFormatted.split(' ')[0]} ä¸‹åˆ4é»å¾Œå–è²¨ï¼š\n`;
            content += `--------------------------------\n`;
            content += `ç„¡è¨‚å–®\n\n`;
          }

          if (tomorrowBefore4.length > 0) {
            content += `${nextDateFormatted.split(' ')[0]} ä¸‹åˆ4é»å‰å–è²¨ï¼š\n`;
            content += `--------------------------------\n`;
            tomorrowBefore4.forEach(order => {
              content += `${order.customerName} - `;
              
              // é¡¯ç¤ºæ‹œæ‹œç”¨å“
              if (order.worshipItems && order.worshipItems.length > 0) {
                order.worshipItems.forEach(item => {
                  const itemInfo = WORSHIP_ITEMS.find(w => w.id === item.itemId);
                  if (itemInfo) {
                    content += `${itemInfo.name} x${item.quantity}`;
                    if (item.filling) content += ` (${item.filling})`;
                    content += ' ';
                  }
                });
              }
              
              // é¡¯ç¤ºå…¶ä»–å•†å“
              if (order.otherItems && order.otherItems.trim()) {
                content += order.otherItems.replace(/\n/g, ' ');
              }
              
              content += '\n';
            });
            content += '\n';
          } else {
            content += `${nextDateFormatted.split(' ')[0]} ä¸‹åˆ4é»å‰å–è²¨ï¼š\n`;
            content += `--------------------------------\n`;
            content += `ç„¡è¨‚å–®\n\n`;
          }

          content += `================================\n`;
          content += `ç¸½è¨ˆï¼š\n`;
          content += `================================\n`;
          if (Object.keys(itemStats).length > 0) {
            Object.entries(itemStats).forEach(([item, count]) => {
              const dots = '.'.repeat(Math.max(2, 30 - item.length - String(count).length));
              content += `${item} ${dots} ${count}\n`;
            });
          } else {
            content += `ç„¡å•†å“\n`;
          }
          content += `================================\n`;

          return content;
        }

        function Statistics({ orders }) {
          const [startDate, setStartDate] = useState('');
          const [endDate, setEndDate] = useState('');
          const [selectedTime, setSelectedTime] = useState('all');
          const [searchKeyword, setSearchKeyword] = useState('');

          const filteredOrders = orders.filter(order => {
            const matchDate = (!startDate || order.pickupDate >= startDate) &&
                             (!endDate || order.pickupDate <= endDate);
            const matchTime = selectedTime === 'all' || order.pickupTime === selectedTime;
            
            // é—œéµå­—æœå°‹
            let matchKeyword = true;
            if (searchKeyword.trim()) {
              const keyword = searchKeyword.toLowerCase();
              matchKeyword = false;
              
              // æœå°‹æ‹œæ‹œç”¨å“
              if (order.worshipItems && order.worshipItems.length > 0) {
                matchKeyword = order.worshipItems.some(item => {
                  const itemInfo = WORSHIP_ITEMS.find(w => w.id === item.itemId);
                  if (itemInfo) {
                    return itemInfo.name.toLowerCase().includes(keyword) ||
                           (item.filling && item.filling.toLowerCase().includes(keyword));
                  }
                  return false;
                });
              }
              
              // æœå°‹å…¶ä»–å•†å“
              if (!matchKeyword && order.otherItems) {
                matchKeyword = order.otherItems.toLowerCase().includes(keyword);
              }
              
              // æœå°‹å®¢æˆ¶åç¨±
              if (!matchKeyword && order.customerName) {
                matchKeyword = order.customerName.toLowerCase().includes(keyword);
              }
            }
            
            return matchDate && matchTime && matchKeyword && order.pickupStatus !== 'å·²å–æ¶ˆ';
          });

          const itemStats = {};
          filteredOrders.forEach(order => {
            const keyword = searchKeyword.trim().toLowerCase();
            
            // çµ±è¨ˆæ‹œæ‹œç”¨å“
            if (order.worshipItems) {
              order.worshipItems.forEach(item => {
                const itemInfo = WORSHIP_ITEMS.find(w => w.id === item.itemId);
                if (itemInfo) {
                  // å¦‚æœæœ‰é—œéµå­—ï¼Œåªçµ±è¨ˆç¬¦åˆçš„å•†å“
                  if (keyword) {
                    const matchName = itemInfo.name.toLowerCase().includes(keyword);
                    const matchFilling = item.filling && item.filling.toLowerCase().includes(keyword);
                    if (!matchName && !matchFilling) {
                      return; // è·³éä¸ç¬¦åˆçš„å•†å“
                    }
                  }
                  
                  const key = item.filling ? 
                    `${itemInfo.name} (${item.filling})` : 
                    itemInfo.name;
                  itemStats[key] = (itemStats[key] || 0) + Number(item.quantity);
                }
              });
            }
            
            // æ™ºèƒ½è§£æä¸¦çµ±è¨ˆå…¶ä»–å•†å“
            if (order.otherItems && order.otherItems.trim()) {
              const lines = order.otherItems.split('\n');
              lines.forEach(line => {
                if (line.trim()) {
                  const parsed = parseOtherItem(line.trim());
                  if (parsed) {
                    // å¦‚æœæœ‰é—œéµå­—ï¼Œåªçµ±è¨ˆç¬¦åˆçš„å•†å“
                    if (keyword) {
                      if (!parsed.name.toLowerCase().includes(keyword)) {
                        return; // è·³éä¸ç¬¦åˆçš„å•†å“
                      }
                    }
                    
                    itemStats[parsed.name] = (itemStats[parsed.name] || 0) + parsed.quantity;
                  }
                }
              });
            }
          });

          const sortedStats = Object.entries(itemStats).sort((a, b) => b[1] - a[1]);

          const handlePrint = () => {
            const content = generateStatisticsContent(startDate, endDate, selectedTime, searchKeyword, sortedStats);
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
              <html>
                <head>
                  <title>å•†å“çµ±è¨ˆ</title>
                  <style>
                    body { font-family: monospace; white-space: pre; font-size: 14px; }
                    @media print {
                      body { margin: 0; padding: 20px; }
                    }
                  </style>
                </head>
                <body>${content}</body>
              </html>
            `);
            printWindow.document.close();
            printWindow.print();
          };

          return (
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '2rem',
              boxShadow: '0 4px 12px rgba(0,0,0,0.08)',
            }}>
              <h2 style={{ fontSize: '1.8rem', color: '#D4915D', marginBottom: '2rem' }}>
                å•†å“çµ±è¨ˆ
              </h2>

              <div style={{
                display: 'grid',
                gridTemplateColumns: '1fr 1fr 1fr 1fr',
                gap: '1rem',
                marginBottom: '1rem',
              }}>
                <Input
                  label="é–‹å§‹æ—¥æœŸ"
                  type="date"
                  value={startDate}
                  onChange={(e) => setStartDate(e.target.value)}
                />
                <Input
                  label="çµæŸæ—¥æœŸ"
                  type="date"
                  value={endDate}
                  onChange={(e) => setEndDate(e.target.value)}
                />
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold', fontSize: '1.1rem' }}>
                    å–è²¨æ™‚æ®µ
                  </label>
                  <select
                    value={selectedTime}
                    onChange={(e) => setSelectedTime(e.target.value)}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      fontSize: '1.1rem',
                      border: '2px solid #E0E0E0',
                      borderRadius: '8px',
                    }}
                  >
                    <option value="all">å…¨éƒ¨æ™‚æ®µ</option>
                    <option value="ä¸‹åˆ4é»å‰">ä¸‹åˆ4é»å‰</option>
                    <option value="ä¸‹åˆ4é»å¾Œ">ä¸‹åˆ4é»å¾Œ</option>
                  </select>
                </div>
                <Input
                  label="é—œéµå­—æœå°‹"
                  type="text"
                  value={searchKeyword}
                  onChange={(e) => setSearchKeyword(e.target.value)}
                  placeholder="å•†å“åç¨±ã€å…§é¤¡ã€å®¢æˆ¶å§“å"
                />
              </div>

              <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '2rem' }}>
                <button
                  onClick={handlePrint}
                  style={{
                    padding: '0.75rem 1.5rem',
                    background: '#2196F3',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '1.1rem',
                    cursor: 'pointer',
                  }}
                >
                  ğŸ–¨ï¸ åˆ—å°
                </button>
              </div>

              <div style={{
                background: '#FFF8E7',
                padding: '1.5rem',
                borderRadius: '8px',
              }}>
                <div style={{
                  fontFamily: 'monospace',
                  fontSize: '1.1rem',
                  lineHeight: '1.8',
                  whiteSpace: 'pre-wrap',
                }}>
                  {generateStatisticsContent(startDate, endDate, selectedTime, searchKeyword, sortedStats)}
                </div>
              </div>
            </div>
          );
        }

        function generateStatisticsContent(startDate, endDate, selectedTime, searchKeyword, sortedStats) {
          let content = `çµ±è¨ˆæœŸé–“ï¼š${startDate || 'ä¸é™'} ~ ${endDate || 'ä¸é™'}\n`;
          content += `å–è²¨æ™‚æ®µï¼š${selectedTime === 'all' ? 'å…¨éƒ¨' : selectedTime}\n`;
          if (searchKeyword.trim()) {
            content += `é—œéµå­—ï¼š${searchKeyword}\n`;
          }
          content += `--------------------------------\n`;
          
          if (sortedStats.length === 0) {
            content += `ç„¡è³‡æ–™\n`;
          } else {
            sortedStats.forEach(([item, count]) => {
              const dots = '.'.repeat(Math.max(2, 35 - item.length - String(count).length));
              content += `${item} ${dots} ${count}\n`;
            });
          }
          
          content += `================================\n`;

          return content;
        }

        function printReceipt(order) {
          let content = `================================\n`;
          content += `      é€²ç™¼ç´ é£ŸéºµåŒ…åº—\n`;
          content += `      è¨‚è³¼æ”¶æ“š\n`;
          content += `================================\n`;
          content += `è¨‚è³¼å…§å®¹\n`;
          
          if (order.worshipItems) {
            order.worshipItems.forEach(item => {
              const itemInfo = WORSHIP_ITEMS.find(w => w.id === item.itemId);
              if (itemInfo) {
                const name = item.filling ? 
                  `${itemInfo.name} (${item.filling}) x${item.quantity}` : 
                  `${itemInfo.name} x${item.quantity}`;
                const price = `$${itemInfo.price * item.quantity}`;
                const spaces = ' '.repeat(Math.max(1, 32 - name.length - price.length));
                content += `${name}${spaces}${price}\n`;
              }
            });
          }

          if (order.otherItems && order.otherItems.trim()) {
            const lines = order.otherItems.split('\n');
            lines.forEach(line => {
              if (line.trim()) {
                content += `${line.trim()}\n`;
              }
            });
          }

          if (order.notes) {
            content += `å‚™è¨»ï¼š${order.notes}\n`;
          }

          content += `--------------------------------\n`;
          
          const totalStr = `$${order.totalAmount}`;
          const depositStr = `$${order.deposit}`;
          const balanceStr = `$${order.totalAmount - order.deposit}`;
          
          content += `ç¸½é‡‘é¡ï¼š${' '.repeat(Math.max(1, 23 - totalStr.length))}${totalStr}\n`;
          content += `è¨‚é‡‘ï¼š${' '.repeat(Math.max(1, 25 - depositStr.length))}${depositStr}\n`;
          content += `å°¾æ¬¾ï¼š${' '.repeat(Math.max(1, 25 - balanceStr.length))}${balanceStr}\n`;
          content += `--------------------------------\n`;
          
          content += `å–è²¨æ™‚é–“ï¼š${formatPickupTime(order.pickupDate, order.pickupTime, order.customPickupTime)}\n`;
          content += `å–è²¨äººï¼š${order.customerName}\n`;
          content += `é›»è©±ï¼š${order.phone}\n`;
          content += `--------------------------------\n`;
          content += `è¨‚å–®ç·¨è™Ÿï¼š${order.id}\n`;
          content += `è¨‚è³¼æ™‚é–“ï¼š${new Date(order.createdAt).toLocaleString('zh-TW')}\n`;
          content += `================================\n`;

          const printWindow = window.open('', '', 'width=400,height=600');
          printWindow.document.write(`
            <html>
              <head>
                <title>è¨‚è³¼æ”¶æ“š - ${order.id}</title>
                <style>
                  body { 
                    font-family: monospace; 
                    white-space: pre; 
                    font-size: 14px;
                    margin: 20px;
                  }
                  @media print {
                    body { margin: 0; padding: 10px; }
                  }
                </style>
              </head>
              <body>${content}</body>
            </html>
          `);
          printWindow.document.close();
          printWindow.print();
        }

        function Section({ title, children }) {
          return (
            <div style={{ marginBottom: '2rem' }}>
              <h3 style={{
                fontSize: '1.3rem',
                color: '#D4915D',
                marginBottom: '1rem',
                borderBottom: '2px solid #FFE8CC',
                paddingBottom: '0.5rem',
              }}>
                {title}
              </h3>
              {children}
            </div>
          );
        }

        function Input({ label, ...props }) {
          return (
            <div>
              <label style={{
                display: 'block',
                marginBottom: '0.5rem',
                fontWeight: 'bold',
                fontSize: '1.1rem',
              }}>
                {label}
              </label>
              <input
                {...props}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  fontSize: '1.1rem',
                  border: '2px solid #E0E0E0',
                  borderRadius: '8px',
                }}
              />
            </div>
          );
        }

        function RadioButton({ checked, onChange, label }) {
          return (
            <label style={{
              display: 'flex',
              alignItems: 'center',
              gap: '0.5rem',
              padding: '0.75rem 1.5rem',
              background: checked ? '#D4915D' : 'white',
              color: checked ? 'white' : '#333',
              border: `2px solid ${checked ? '#D4915D' : '#E0E0E0'}`,
              borderRadius: '8px',
              cursor: 'pointer',
              fontSize: '1.1rem',
              fontWeight: checked ? 'bold' : 'normal',
              transition: 'all 0.2s',
            }}>
              <input
                type="radio"
                checked={checked}
                onChange={onChange}
                style={{ display: 'none' }}
              />
              {label}
            </label>
          );
        }

        // æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BakeryOrderSystem />);
    </script>
</body>
</html>
